<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo Mejorado - Números Primos</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #FFD700;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-light: rgba(255, 255, 255, 0.95);
            --bg-dark: rgba(0, 0, 0, 0.9);
            --shadow-light: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-heavy: 0 8px 40px rgba(0,0,0,0.3);
            --transition-fast: all 0.2s ease;
            --transition-smooth: all 0.3s ease;
            
            /* Colores para tipos de primos */
            --prime-regular: #4D96FF;
            --prime-twin: #FF0000;
            --prime-cousin: #FF8C00;
            --prime-sexy: #FF1493;
            --prime-sophie: #9400D3;
            --prime-palindromic: #FFD700;
            --prime-mersenne: #00FFFF;
            --prime-fermat: #ADFF2F;
            --composite: #404040;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        .app-header {
            background: var(--bg-dark);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--accent-color);
        }
        
        .app-title {
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-color), #FF6B9D, #00FFFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .app-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            color: #e2e8f0;
        }
        
        .main-container {
            display: flex;
            min-height: calc(100vh - 140px);
            gap: 1rem;
            padding: 1rem;
        }
        
        /* Panel de Control Mejorado */
        .control-panel {
            width: 350px;
            background: var(--bg-light);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-section {
            margin-bottom: 2.5rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: var(--transition-smooth);
            background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Estilos específicos para campos numéricos */
        input[type="number"] {
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }
        
        .range-container {
            position: relative;
            margin-top: 0.5rem;
        }
        
        .range-value {
            position: absolute;
            right: 0;
            top: -0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-color);
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .checkbox-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }
        
        .checkbox-item.checked {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        .checkbox-label {
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }
        
        .prime-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .generate-button {
            width: 100%;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .generate-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .generate-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Botón de ayuda */
        .help-button {
            background: var(--accent-color);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition-fast);
            margin-left: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            background: #FFE55C;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        /* Modal de ayuda */
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        
        .help-modal.show {
            display: flex;
        }
        
        .help-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 3px solid var(--accent-color);
        }
        
        .help-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .help-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .help-close {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition-fast);
        }
        
        .help-close:hover {
            background: #ff3742;
            transform: scale(1.1);
        }
        
        .help-section {
            margin-bottom: 2.5rem;
        }
        
        .help-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-parameter {
            background: rgba(102, 126, 234, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-color);
        }
        
        .help-parameter-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-parameter-desc {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .help-parameter-example {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #2d3748;
            border-left: 4px solid var(--accent-color);
        }
        
        .help-prime-type {
            background: rgba(255, 215, 0, 0.05);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 5px solid var(--accent-color);
        }
        
        .help-prime-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .help-prime-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        
        .help-prime-desc {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .help-prime-formula {
            background: #f1f5f9;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #475569;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading-spinner.active {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.75rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Panel de Visualización Mejorado */
        .visualization-panel {
            flex: 1;
            background: var(--bg-light);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .visualization-header {
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .visualization-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .visualization-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .control-button {
            padding: 0.75rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        /* Mapa Interactivo Responsivo */
        .interactive-map {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            cursor: crosshair;
            min-height: 500px;
        }
        
        .prime-map-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        }
        
        .prime-element {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 2px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        
        .prime-element:hover {
            transform: scale(2.5);
            z-index: 100;
            border-width: 3px;
            filter: brightness(1.4) saturate(1.3);
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
        }
        
        /* Estilos para diferentes tipos de números */
        .prime-element.compuesto {
            background: var(--composite);
            opacity: 0.4;
            border-color: rgba(255,255,255,0.05);
        }
        
        .prime-element.regular {
            background: var(--prime-regular);
            box-shadow: 0 0 6px rgba(77, 150, 255, 0.4);
        }
        
        .prime-element.gemelo {
            background: var(--prime-twin);
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
            animation: twin-glow 3s ease-in-out infinite;
        }
        
        .prime-element.primo {
            background: var(--prime-cousin);
            box-shadow: 0 0 8px rgba(255, 140, 0, 0.5);
        }
        
        .prime-element.sexy {
            background: var(--prime-sexy);
            box-shadow: 0 0 10px rgba(255, 20, 147, 0.5);
        }
        
        .prime-element.sophie_germain {
            background: var(--prime-sophie);
            box-shadow: 0 0 12px rgba(148, 0, 211, 0.6);
            animation: sophie-pulse 4s ease-in-out infinite;
        }
        
        .prime-element.palindromico {
            background: var(--prime-palindromic);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: palindrome-sparkle 2s ease-in-out infinite;
        }
        
        .prime-element.mersenne {
            background: var(--prime-mersenne);
            box-shadow: 0 0 20px rgba(0, 255, 255, 1);
            animation: mersenne-shine 2.5s ease-in-out infinite;
        }
        
        .prime-element.fermat {
            background: var(--prime-fermat);
            box-shadow: 0 0 18px rgba(173, 255, 47, 0.9);
            animation: fermat-glow 3.5s ease-in-out infinite;
        }
        
        .prime-element.multiple-types {
            background: linear-gradient(45deg, var(--prime-twin), var(--prime-mersenne), var(--prime-palindromic));
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.9);
            animation: multi-rainbow 1.5s linear infinite;
        }
        
        @keyframes twin-glow {
            0%, 100% { box-shadow: 0 0 12px rgba(255, 0, 0, 0.6); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.9); }
        }
        
        @keyframes sophie-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes palindrome-sparkle {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5) saturate(1.5); }
        }
        
        @keyframes mersenne-shine {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 1); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 255, 1), 0 0 40px rgba(255, 255, 255, 0.5); }
        }
        
        @keyframes fermat-glow {
            0%, 100% { box-shadow: 0 0 18px rgba(173, 255, 47, 0.9); }
            50% { box-shadow: 0 0 25px rgba(173, 255, 47, 1); }
        }
        
        @keyframes multi-rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        /* Tooltip Matemático Avanzado */
        .number-tooltip {
            position: absolute;
            background: var(--bg-dark);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8) translateY(10px);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            z-index: 1000;
            min-width: 350px;
            max-width: 500px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .number-tooltip.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        .tooltip-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .tooltip-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .tooltip-type-badge {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tooltip-content {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .tooltip-section {
            margin-bottom: 1rem;
        }
        
        .tooltip-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tooltip-property {
            background: rgba(255,255,255,0.05);
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--accent-color);
        }
        
        .tooltip-formula {
            font-family: 'Courier New', Monaco, monospace;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--accent-color);
        }
        
        /* Panel de Estadísticas */
        .stats-panel {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-dark);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            min-width: 250px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .stats-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .stats-label {
            color: #cbd5e0;
        }
        
        .stats-value {
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }
        
        .error-message {
            background: #ff4757;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            text-align: center;
            font-weight: 600;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .control-panel {
                width: 100%;
                max-height: 50vh;
                padding: 1.5rem;
            }
            
            .interactive-map {
                min-height: 60vh;
            }
            
            .checkbox-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
            }
            
            .app-title {
                font-size: 1.8rem;
            }
            
            .number-tooltip {
                min-width: 280px;
                max-width: 90vw;
                font-size: 0.9rem;
            }
            
            .tooltip-number {
                font-size: 1.7rem;
            }
            
            .stats-panel {
                position: relative;
                top: auto;
                right: auto;
                margin: 1rem;
                order: -1;
            }
        }
        
        @media (max-width: 480px) {
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            .number-tooltip {
                min-width: 260px;
                padding: 1rem;
            }
            
            .tooltip-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="app-title">
            <i class="fas fa-infinity"></i>
            Mapa Interactivo Mejorado - Números Primos
        </div>
        <div class="app-subtitle">
            Nueva API responsiva • Tooltips matemáticos avanzados • Rendimiento optimizado
        </div>
    </div>
    
    <div class="main-container">
        <!-- Panel de Control -->
        <div class="control-panel">
            <div class="control-section">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    Configuración Matemática
                    <button class="help-button" id="help-config" title="Ayuda sobre configuración">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Círculos Concéntricos (1-10,000):</label>
                    <input type="number" id="num_circulos" min="1" max="10000" value="10000" class="form-input" placeholder="Ingrese número de círculos">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Segmentos por Círculo (2-1,300):</label>
                    <input type="number" id="divisiones_por_circulo" min="2" max="1300" value="1300" class="form-input" placeholder="Ingrese número de segmentos">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Mapeo:</label>
                    <select id="tipo_mapeo" class="form-select">
                        <option value="lineal">Lineal Secuencial</option>
                        <option value="logaritmico">Logarítmico</option>
                        <option value="arquimedes">Espiral de Arquímedes</option>
                        <option value="fibonacci">Espiral de Fibonacci</option>
                    </select>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">
                    <i class="fas fa-atom"></i>
                    Tipos de Primos
                </div>
                
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_regular" checked>
                        <div class="prime-color-indicator" style="background: var(--prime-regular);"></div>
                        <label class="checkbox-label">Primos Regulares</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_twins" checked>
                        <div class="prime-color-indicator" style="background: var(--prime-twin);"></div>
                        <label class="checkbox-label">Primos Gemelos</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_cousins" checked>
                        <div class="prime-color-indicator" style="background: var(--prime-cousin);"></div>
                        <label class="checkbox-label">Primos Primos</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_sexy">
                        <div class="prime-color-indicator" style="background: var(--prime-sexy);"></div>
                        <label class="checkbox-label">Primos Sexy</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_sophie">
                        <div class="prime-color-indicator" style="background: var(--prime-sophie);"></div>
                        <label class="checkbox-label">Sophie Germain</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_palindromic">
                        <div class="prime-color-indicator" style="background: var(--prime-palindromic);"></div>
                        <label class="checkbox-label">Palindrómicos</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_mersenne">
                        <div class="prime-color-indicator" style="background: var(--prime-mersenne);"></div>
                        <label class="checkbox-label">Mersenne</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_fermat">
                        <div class="prime-color-indicator" style="background: var(--prime-fermat);"></div>
                        <label class="checkbox-label">Fermat</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="show_composite" checked>
                        <div class="prime-color-indicator" style="background: var(--composite);"></div>
                        <label class="checkbox-label">Compuestos</label>
                    </div>
                </div>
            </div>
            
            <button class="generate-button" id="generate-btn">
                <span class="loading-spinner" id="loading-spinner"></span>
                <i class="fas fa-rocket"></i>
                Generar Mapa Responsivo
            </button>
            
            <!-- Nuevo botón para descargar imagen -->
            <button class="generate-button" id="download-btn" style="margin-top: 1rem; background: linear-gradient(135deg, #FF6B9D, #C44569);">
                <span class="loading-spinner" id="download-spinner"></span>
                <i class="fas fa-download"></i>
                Descargar Imagen PNG
            </button>
        </div>
        
        <!-- Panel de Visualización -->
        <div class="visualization-panel">
            <div class="visualization-header">
                <div class="visualization-title">
                    <i class="fas fa-project-diagram"></i>
                    Mapa Matemático Interactivo
                </div>
                <div class="visualization-controls">
                    <button class="control-button" id="zoom-in" title="Ampliar">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="control-button" id="zoom-out" title="Reducir">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="control-button" id="reset-zoom" title="Reiniciar Vista">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <button class="control-button" id="fullscreen" title="Pantalla Completa">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            
            <div class="interactive-map" id="interactive-map">
                <div class="prime-map-container" id="map-container">
                    <!-- Los elementos se generarán aquí dinámicamente -->
                </div>
                
                <!-- Panel de Estadísticas -->
                <div class="stats-panel" id="stats-panel">
                    <div class="stats-title">
                        <i class="fas fa-chart-line"></i>
                        Estadísticas en Tiempo Real
                    </div>
                    <div id="stats-content">
                        <div class="stats-item">
                            <span class="stats-label">Rango:</span>
                            <span class="stats-value">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Ayuda -->
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <div class="help-header">
                <div class="help-title">
                    <i class="fas fa-graduation-cap"></i>
                    Guía de Parámetros y Tipos de Primos
                </div>
                <button class="help-close" id="help-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="help-section">
                <div class="help-section-title">
                    <i class="fas fa-cogs"></i>
                    Parámetros de Configuración
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-circle-notch"></i>
                        Círculos Concéntricos (1-10,000)
                    </div>
                    <div class="help-parameter-desc">
                        Define cuántos anillos concéntricos se crearán desde el centro. Cada círculo representa un nivel de distancia del origen. ¡Ahora puedes usar hasta 10,000 círculos para visualizaciones ultra-detalladas!
                    </div>
                    <div class="help-parameter-example">
                        Ejemplo: 10,000 círculos × 1,300 segmentos = 13,000,000 posiciones totales
                    </div>
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-chart-pie"></i>
                        Segmentos por Círculo (2-1,300)
                    </div>
                    <div class="help-parameter-desc">
                        Número de divisiones angulares en cada círculo. Determina la resolución angular de la visualización. ¡Ahora hasta 1,300 segmentos para resolución extrema!
                    </div>
                    <div class="help-parameter-example">
                        1,300 segmentos = 360°/1,300 = 0.28° por segmento (resolución ultra-fina)
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <div class="help-section-title">
                    <i class="fas fa-project-diagram"></i>
                    Tipos de Mapeo Geométrico
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-arrows-alt-h"></i>
                        Lineal Secuencial
                    </div>
                    <div class="help-parameter-desc">
                        Distribución secuencial estándar. Los números se colocan en orden desde el centro hacia afuera, círculo por círculo.
                    </div>
                    <div class="help-parameter-example">
                        1→2→3...→1,300 (círculo 1), 1,301→1,302→...→2,600 (círculo 2)
                    </div>
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-chart-line"></i>
                        Logarítmico
                    </div>
                    <div class="help-parameter-desc">
                        Mapeo basado en logaritmo natural. Enfatiza los números pequeños y comprime los grandes, útil para estudiar la distribución de primos pequeños.
                    </div>
                    <div class="help-parameter-example">
                        Posición = log(n) / log(total) × posiciones_disponibles
                    </div>
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-sync"></i>
                        Espiral de Arquímedes
                    </div>
                    <div class="help-parameter-desc">
                        Espiral donde el radio aumenta proporcionalmente con el ángulo (r = aθ). Crea patrones visuales únicos para detectar simetrías en la distribución de primos.
                    </div>
                    <div class="help-parameter-example">
                        θ = 2π√(n/total), r = √(n/total) × círculos_max
                    </div>
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-seedling"></i>
                        Espiral de Fibonacci
                    </div>
                    <div class="help-parameter-desc">
                        Basado en la razón áurea (φ = 1.618...). Relaciona números primos con patrones naturales como girasoles y caracolas. Revela conexiones profundas.
                    </div>
                    <div class="help-parameter-example">
                        θ = 2π × n / φ, donde φ = (1+√5)/2
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <div class="help-section-title">
                    <i class="fas fa-atom"></i>
                    Tipos Especiales de Números Primos
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-regular);"></div>
                        Primos Regulares
                    </div>
                    <div class="help-prime-desc">
                        Números primos básicos que no pertenecen a categorías especiales. Forman la base de la teoría de números.
                    </div>
                    <div class="help-prime-formula">Ejemplos: 7, 11, 23, 29, 41...</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-twin);"></div>
                        Primos Gemelos
                    </div>
                    <div class="help-prime-desc">
                        Pares de primos que difieren en 2 unidades. Conjetura fundamental no resuelta: ¿existen infinitos pares gemelos?
                    </div>
                    <div class="help-prime-formula">Pares: (3,5), (5,7), (11,13), (17,19), (29,31)...</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-cousin);"></div>
                        Primos Primos (Cousin)
                    </div>
                    <div class="help-prime-desc">
                        Pares de primos que difieren en 4 unidades. Menos comunes que los gemelos pero importantes para el análisis de gaps.
                    </div>
                    <div class="help-prime-formula">Pares: (3,7), (7,11), (13,17), (19,23), (37,41)...</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-sexy);"></div>
                        Primos Sexy
                    </div>
                    <div class="help-prime-desc">
                        Pares de primos que difieren en 6 unidades. El nombre viene de "sex" (seis en latín), no tiene connotación sexual.
                    </div>
                    <div class="help-prime-formula">Pares: (5,11), (7,13), (13,19), (23,29), (31,37)...</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-sophie);"></div>
                        Sophie Germain
                    </div>
                    <div class="help-prime-desc">
                        Primo p tal que 2p+1 también es primo. Nombrados por la matemática Sophie Germain (1776-1831). Fundamentales en criptografía.
                    </div>
                    <div class="help-prime-formula">Si p es Sophie Germain: 2p+1 también es primo<br>Ejemplos: 2→5, 3→7, 5→11, 11→23</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-palindromic);"></div>
                        Palindrómicos
                    </div>
                    <div class="help-prime-desc">
                        Números primos que se leen igual de izquierda a derecha que de derecha a izquierda. Combinan propiedades aritméticas con simetría.
                    </div>
                    <div class="help-prime-formula">Ejemplos: 11, 101, 131, 151, 181, 191, 313...</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-mersenne);"></div>
                        Primos de Mersenne
                    </div>
                    <div class="help-prime-desc">
                        Primos de la forma 2^p - 1 donde p también es primo. Cruciales para encontrar números perfectos y en pruebas de primalidad.
                    </div>
                    <div class="help-prime-formula">M₂ = 2² - 1 = 3, M₃ = 2³ - 1 = 7, M₅ = 2⁵ - 1 = 31, M₇ = 2⁷ - 1 = 127</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--prime-fermat);"></div>
                        Primos de Fermat
                    </div>
                    <div class="help-prime-desc">
                        Primos de la forma 2^(2^n) + 1. Solo se conocen 5: F₀, F₁, F₂, F₃, F₄. Fundamentales en geometría constructible.
                    </div>
                    <div class="help-prime-formula">F₀=3, F₁=5, F₂=17, F₃=257, F₄=65537<br>Construcción de polígonos regulares con regla y compás</div>
                </div>
                
                <div class="help-prime-type">
                    <div class="help-prime-name">
                        <div class="help-prime-color" style="background: var(--composite);"></div>
                        Números Compuestos
                    </div>
                    <div class="help-prime-desc">
                        Números enteros mayores que 1 que no son primos. Tienen factores propios y forman el "fondo" contra el cual destacan los primos.
                    </div>
                    <div class="help-prime-formula">Ejemplos: 4=2×2, 6=2×3, 8=2³, 9=3², 10=2×5...</div>
                </div>
            </div>
            
            <div class="help-section">
                <div class="help-section-title">
                    <i class="fas fa-lightbulb"></i>
                    Tips de Uso
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-mouse"></i>
                        Interactividad
                    </div>
                    <div class="help-parameter-desc">
                        • Hover sobre cualquier punto para ver análisis matemático completo<br>
                        • Use zoom para explorar detalles<br>
                        • Configure diferentes mapeos para revelar patrones únicos<br>
                        • Descargue imágenes con nombres descriptivos de parámetros
                    </div>
                </div>
                
                <div class="help-parameter">
                    <div class="help-parameter-name">
                        <i class="fas fa-download"></i>
                        Descarga Inteligente
                    </div>
                    <div class="help-parameter-desc">
                        Las imágenes se descargan con nombres que incluyen todos los parámetros usados:
                    </div>
                    <div class="help-parameter-example">
                        primos_15c_36s_fibonacci_clasico_gemelos-sophie_20251025-033349.png
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltip Matemático -->
    <div class="number-tooltip" id="number-tooltip">
        <div class="tooltip-header">
            <div class="tooltip-number" id="tooltip-number">2</div>
            <div class="tooltip-type-badge" id="tooltip-type-badge">Primo</div>
        </div>
        
        <div class="tooltip-content" id="tooltip-content">
            <!-- El contenido se llenará dinámicamente -->
        </div>
    </div>

    <script>
        // Variables globales
        let mapData = {
            elementos: [],
            estadisticas: {},
            zoom: 1,
            centerX: 0,
            centerY: 0
        };
        
        let isLoading = false;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando Mapa Mejorado...');
            initializeControls();
            generateMap();
        });
        
        // Configurar controles
        function initializeControls() {
            const circlesInput = document.getElementById('num_circulos');
            const segmentsInput = document.getElementById('divisiones_por_circulo');
            
            // Debounce para mejor performance
            let debounceTimer;
            
            // Validar y formatear entrada de círculos
            circlesInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value > 10000) this.value = 10000;
                if (value < 1) this.value = 1;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(generateMap, 500);
            });
            
            // Validar y formatear entrada de segmentos
            segmentsInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value > 1300) this.value = 1300;
                if (value < 2) this.value = 2;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(generateMap, 500);
            });
            
            // Selector de mapeo
            document.getElementById('tipo_mapeo').addEventListener('change', generateMap);
            
            // Checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    this.closest('.checkbox-item').classList.toggle('checked', this.checked);
                    generateMap();
                });
                checkbox.closest('.checkbox-item').classList.toggle('checked', checkbox.checked);
            });
            
            // Controles de zoom
            document.getElementById('zoom-in').addEventListener('click', () => zoomMap(1.3));
            document.getElementById('zoom-out').addEventListener('click', () => zoomMap(0.7));
            document.getElementById('reset-zoom').addEventListener('click', resetZoom);
            
            // Botón generar
            document.getElementById('generate-btn').addEventListener('click', generateMap);
            
            // Botón descargar - Nueva funcionalidad
            document.getElementById('download-btn').addEventListener('click', downloadImage);
            
            // Botón de ayuda - Modal explicativo
            document.getElementById('help-config').addEventListener('click', showHelpModal);
            
            // Control del modal de ayuda
            document.getElementById('help-close').addEventListener('click', hideHelpModal);
            document.getElementById('help-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideHelpModal();
                }
            });
            
            // Cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('help-modal').classList.contains('show')) {
                    hideHelpModal();
                }
            });
        }
        
        // Funciones del modal de ayuda
        function showHelpModal() {
            const modal = document.getElementById('help-modal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            console.log('📚 Mostrando guía de ayuda');
        }
        
        function hideHelpModal() {
            const modal = document.getElementById('help-modal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        
        // Nueva función para descargar imagen con nombres paramétricos
        async function downloadImage() {
            if (isLoading) return;
            
            console.log('📥 Descargando imagen con nombres paramétricos...');
            showDownloadLoading(true);
            
            try {
                // Recopilar parámetros (mapear desde mapa interactivo a backend)
                const params = {
                    num_circulos: parseInt(document.getElementById('num_circulos').value),
                    divisiones_por_circulo: parseInt(document.getElementById('divisiones_por_circulo').value),
                    tipo_mapeo: document.getElementById('tipo_mapeo').value,
                    esquema_color: 'clasico', // Por defecto para compatibilidad
                    calidad_renderizado: 'alta', // Alta calidad para descarga
                    mostrar_primos_gemelos: document.getElementById('show_twins').checked,
                    mostrar_primos_primos: document.getElementById('show_cousins').checked,
                    mostrar_primos_sexy: document.getElementById('show_sexy').checked,
                    mostrar_primos_regulares: document.getElementById('show_regular').checked,
                    mostrar_sophie_germain: document.getElementById('show_sophie').checked,
                    mostrar_palindromos: document.getElementById('show_palindromic').checked,
                    mostrar_mersenne: document.getElementById('show_mersenne').checked,
                    mostrar_fermat: document.getElementById('show_fermat').checked,
                    incluir_leyenda: true,
                    formato_exportacion: 'png',
                    comprimir_salida: false, // Sin compresión para mejor calidad
                    usar_cache: true
                };
                
                // Llamar al endpoint de descarga
                const response = await fetch('/descargar-imagen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                // Obtener blob de la imagen
                const blob = await response.blob();
                
                // Obtener nombre del archivo desde headers
                const filename = response.headers.get('X-Filename') || 'primos_visualization.png';
                const generationTime = response.headers.get('X-Generation-Time') || 'N/A';
                const totalPrimos = response.headers.get('X-Total-Primos') || 'N/A';
                
                // Crear enlace de descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Mostrar notificación de éxito
                showDownloadSuccess(filename, generationTime, totalPrimos);
                
                console.log(`✅ Imagen descargada: ${filename}`);
                
            } catch (error) {
                console.error('❌ Error descargando imagen:', error);
                showDownloadError(`Error: ${error.message}`);
            } finally {
                showDownloadLoading(false);
            }
        }
        
        // Funciones auxiliares para la descarga
        function showDownloadLoading(show) {
            const spinner = document.getElementById('download-spinner');
            const button = document.getElementById('download-btn');
            const buttonIcon = button.querySelector('i');
            
            spinner.classList.toggle('active', show);
            button.disabled = show;
            
            if (show) {
                buttonIcon.className = 'fas fa-cog fa-spin';
                button.innerHTML = '<span class="loading-spinner active"></span><i class="fas fa-cog fa-spin"></i> Generando...';
            } else {
                buttonIcon.className = 'fas fa-download';
                button.innerHTML = '<i class="fas fa-download"></i> Descargar Imagen PNG';
            }
        }
        
        function showDownloadSuccess(filename, generationTime, totalPrimos) {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; top: 20px; right: 20px; 
                    background: linear-gradient(135deg, #00C851, #007E33); 
                    color: white; padding: 1.5rem; border-radius: 12px; 
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                    z-index: 10000; max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                ">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-check-circle" style="font-size: 1.5rem; color: #FFD700;"></i>
                        <strong>¡Descarga Exitosa!</strong>
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        <div><strong>Archivo:</strong> ${filename}</div>
                        <div><strong>Tiempo:</strong> ${generationTime}s</div>
                        <div><strong>Primos:</strong> ${totalPrimos.toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        function showDownloadError(message) {
            // Crear notificación de error temporal
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; top: 20px; right: 20px; 
                    background: linear-gradient(135deg, #FF4757, #C23616); 
                    color: white; padding: 1.5rem; border-radius: 12px; 
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                    z-index: 10000; max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                ">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: #FFD700;"></i>
                        <strong>Error en descarga</strong>
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Generar mapa usando la nueva API
        async function generateMap() {
            if (isLoading) return;
            
            console.log('🎨 Generando mapa con API mejorada...');
            showLoading(true);
            
            try {
                // Recopilar parámetros
                const params = {
                    num_circulos: parseInt(document.getElementById('num_circulos').value),
                    divisiones_por_circulo: parseInt(document.getElementById('divisiones_por_circulo').value),
                    tipo_mapeo: document.getElementById('tipo_mapeo').value,
                    mostrar_regulares: document.getElementById('show_regular').checked,
                    mostrar_gemelos: document.getElementById('show_twins').checked,
                    mostrar_primos: document.getElementById('show_cousins').checked,
                    mostrar_sexy: document.getElementById('show_sexy').checked,
                    mostrar_sophie_germain: document.getElementById('show_sophie').checked,
                    mostrar_palindromicos: document.getElementById('show_palindromic').checked,
                    mostrar_mersenne: document.getElementById('show_mersenne').checked,
                    mostrar_fermat: document.getElementById('show_fermat').checked,
                    mostrar_compuestos: document.getElementById('show_composite').checked
                };
                
                // Llamar a la API
                const response = await fetch('/api/interactive-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                mapData = data;
                renderMap();
                updateStatistics();
                
                console.log(`✅ Mapa generado: ${data.elementos.length} elementos`);
                
            } catch (error) {
                console.error('❌ Error generando mapa:', error);
                showError(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // Renderizar mapa visual
        function renderMap() {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = '';
            
            if (!mapData.elementos || mapData.elementos.length === 0) {
                mapContainer.innerHTML = '<div class="error-message">No hay datos para mostrar</div>';
                return;
            }
            
            const mapWidth = mapContainer.offsetWidth || 800;
            const mapHeight = mapContainer.offsetHeight || 600;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            const maxRadius = Math.min(centerX, centerY) - 60;
            
            // Crear elementos visuales
            mapData.elementos.forEach(elemento => {
                const elementDiv = createPrimeElement(elemento, centerX, centerY, maxRadius);
                mapContainer.appendChild(elementDiv);
            });
            
            console.log(`🎨 Renderizados ${mapData.elementos.length} elementos`);
        }
        
        // Crear elemento visual para un número
        function createPrimeElement(elemento, centerX, centerY, maxRadius) {
            const div = document.createElement('div');
            div.className = 'prime-element';
            div.dataset.number = elemento.numero;
            
            // Agregar clases CSS según tipos
            if (elemento.tipos && elemento.tipos.length > 0) {
                if (elemento.tipos.length > 1) {
                    div.classList.add('multiple-types');
                } else {
                    div.classList.add(elemento.tipos[0]);
                }
            }
            
            // Calcular posición cartesiana
            const radius = elemento.posicion.radio * maxRadius;
            const angle = elemento.posicion.angulo;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            // Tamaño adaptativo
            let size = Math.max(3, 8 - elemento.circulo * 0.3);
            if (elemento.tipos.includes('mersenne') || elemento.tipos.includes('fermat')) {
                size *= 1.5;
            }
            
            div.style.width = `${size}px`;
            div.style.height = `${size}px`;
            div.style.left = `${x - size/2}px`;
            div.style.top = `${y - size/2}px`;
            
            // Eventos
            div.addEventListener('mouseenter', (e) => showTooltip(e, elemento));
            div.addEventListener('mouseleave', hideTooltip);
            div.addEventListener('mousemove', updateTooltipPosition);
            
            return div;
        }
        
        // Mostrar tooltip con información matemática
        async function showTooltip(event, elemento) {
            const tooltip = document.getElementById('number-tooltip');
            const tooltipNumber = document.getElementById('tooltip-number');
            const tooltipTypeBadge = document.getElementById('tooltip-type-badge');
            const tooltipContent = document.getElementById('tooltip-content');
            
            tooltipNumber.textContent = elemento.numero.toLocaleString();
            tooltipTypeBadge.textContent = elemento.es_primo ? 'PRIMO' : 'COMPUESTO';
            tooltipTypeBadge.style.background = elemento.es_primo ? 
                'linear-gradient(45deg, var(--primary-color), var(--secondary-color))' :
                'linear-gradient(45deg, #666, #999)';
            
            // Mostrar información básica inmediatamente
            tooltipContent.innerHTML = `
                <div class="tooltip-section">
                    <div class="tooltip-section-title">
                        <i class="fas fa-info-circle"></i>
                        Propiedades
                    </div>
                    <div class="tooltip-property">
                        ${elemento.es_primo ? 'Número primo' : 'Número compuesto'}
                    </div>
                    <div class="tooltip-property">
                        Tipos: ${elemento.tipos.join(', ')}
                    </div>
                    <div class="tooltip-property">
                        Posición: Círculo ${elemento.circulo + 1}, Segmento ${elemento.segmento + 1}
                    </div>
                </div>
                <div class="tooltip-section">
                    <div class="tooltip-section-title">
                        <i class="fas fa-calculator"></i>
                        Matemáticas
                    </div>
                    <div class="tooltip-formula">
                        ${elemento.numero % 2 === 0 ? 'Par' : 'Impar'}
                    </div>
                    <div class="tooltip-formula">
                        ${elemento.numero} ≡ ${elemento.numero % 6} (mod 6)
                    </div>
                    <div class="tooltip-formula">
                        Binario: ${elemento.numero.toString(2)}
                    </div>
                </div>
            `;
            
            updateTooltipPosition(event);
            tooltip.classList.add('visible');
            
            // Cargar información detallada de manera asíncrona
            try {
                const response = await fetch(`/api/number/${elemento.numero}`);
                if (response.ok) {
                    const data = await response.json();
                    updateTooltipWithDetailedInfo(data);
                }
            } catch (error) {
                console.error('Error cargando información detallada:', error);
            }
        }
        
        // Actualizar tooltip con información detallada
        function updateTooltipWithDetailedInfo(data) {
            const tooltipContent = document.getElementById('tooltip-content');
            
            let propertiesHtml = '';
            if (data.propiedades && data.propiedades.length > 0) {
                data.propiedades.forEach(prop => {
                    propertiesHtml += `<div class="tooltip-property">${prop}</div>`;
                });
            }
            
            let formulasHtml = '';
            if (data.formulas && data.formulas.length > 0) {
                data.formulas.forEach(formula => {
                    formulasHtml += `<div class="tooltip-formula">${formula}</div>`;
                });
            }
            
            let typesHtml = '';
            if (data.tipos_primo && data.tipos_primo.length > 0) {
                data.tipos_primo.forEach(type => {
                    typesHtml += `<div class="tooltip-property">${type}</div>`;
                });
            }
            
            tooltipContent.innerHTML = `
                <div class="tooltip-section">
                    <div class="tooltip-section-title">
                        <i class="fas fa-info-circle"></i>
                        Propiedades Matemáticas
                    </div>
                    ${propertiesHtml}
                    ${typesHtml}
                </div>
                <div class="tooltip-section">
                    <div class="tooltip-section-title">
                        <i class="fas fa-calculator"></i>
                        Fórmulas y Análisis
                    </div>
                    ${formulasHtml}
                </div>
            `;
        }
        
        // Ocultar tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('number-tooltip');
            tooltip.classList.remove('visible');
        }
        
        // Actualizar posición del tooltip
        function updateTooltipPosition(event) {
            const tooltip = document.getElementById('number-tooltip');
            const rect = tooltip.getBoundingClientRect();
            
            let x = event.clientX + 20;
            let y = event.clientY - 10;
            
            // Ajustar si se sale de pantalla
            if (x + rect.width > window.innerWidth - 20) {
                x = event.clientX - rect.width - 20;
            }
            if (y + rect.height > window.innerHeight - 20) {
                y = event.clientY - rect.height - 10;
            }
            if (y < 20) {
                y = event.clientY + 20;
            }
            
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
        
        // Actualizar estadísticas
        function updateStatistics() {
            const statsContent = document.getElementById('stats-content');
            const stats = mapData.estadisticas;
            
            if (!stats) return;
            
            statsContent.innerHTML = `
                <div class="stats-item">
                    <span class="stats-label">Rango:</span>
                    <span class="stats-value">1 - ${stats.total_numeros.toLocaleString()}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Total Primos:</span>
                    <span class="stats-value">${stats.total_primos.toLocaleString()}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Densidad:</span>
                    <span class="stats-value">${stats.densidad_primos.toFixed(2)}%</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Gemelos:</span>
                    <span class="stats-value">${stats.patrones.gemelos}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Sophie Germain:</span>
                    <span class="stats-value">${stats.patrones.sophie_germain}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Mersenne:</span>
                    <span class="stats-value">${stats.patrones.mersenne}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Mapeo:</span>
                    <span class="stats-value">${stats.configuracion.mapeo}</span>
                </div>
            `;
        }
        
        // Control de zoom
        function zoomMap(factor) {
            mapData.zoom *= factor;
            mapData.zoom = Math.max(0.3, Math.min(mapData.zoom, 5));
            
            const mapContainer = document.getElementById('map-container');
            mapContainer.style.transform = `scale(${mapData.zoom})`;
        }
        
        function resetZoom() {
            mapData.zoom = 1;
            const mapContainer = document.getElementById('map-container');
            mapContainer.style.transform = 'scale(1)';
        }
        
        // UI helpers
        function showLoading(show) {
            isLoading = show;
            const spinner = document.getElementById('loading-spinner');
            const button = document.getElementById('generate-btn');
            const buttonIcon = button.querySelector('i');
            
            spinner.classList.toggle('active', show);
            button.disabled = show;
            
            if (show) {
                buttonIcon.className = 'fas fa-cog fa-spin';
            } else {
                buttonIcon.className = 'fas fa-rocket';
            }
        }
        
        function showError(message) {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = `<div class="error-message">${message}</div>`;
            console.error('❌', message);
        }
        
        console.log('✅ Mapa Interactivo Mejorado cargado completamente');
    </script>
</body>
</html>